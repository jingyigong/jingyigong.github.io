<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>格言卡片设计器 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            display: flex;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: white;
        }

        .control-panel {
            width: 380px;
            height: 100vh;
            overflow-y: auto;
            background: white;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .control-panel::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .preview-header {
            padding: 1.5rem 2rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow: auto;
        }

        .canvas-wrapper {
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .canvas-container {
            position: relative;
            width: 750px;
            height: 750px;
        }

        .canvas-background {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
        }

        .canvas-content {
            position: absolute;
            inset: 0;
            padding: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
        }

        .text-element {
            text-align: center;
            white-space: pre-line;
            word-wrap: break-word;
        }

        .highlight-mark {
            display: inline;
            line-height: inherit;
            vertical-align: baseline;
        }

        #highlighterLayer {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .collapsible-section {
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .collapsible-header {
            padding: 1rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .collapsible-header:hover {
            background-color: #f9fafb;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
        }

        .collapsible-body {
            padding: 1rem;
        }

        .size-preset, .template-card {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .size-preset:hover, .template-card:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .size-preset.active, .template-card.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .color-preset {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: transform 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        .color-preset.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            animation: scaleIn 0.3s;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-ghost { background: #f3f4f6; color: #374151; }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .toolbar-btn {
            padding: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #f3f4f6;
        }

        .toolbar-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .control-panel {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }
            
            .preview-panel {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 控制面板 -->
        <div class="control-panel">
            <!-- 顶部工具栏 -->
            <div class="toolbar" style="margin-bottom: 1rem;">
                <button class="toolbar-btn" id="undoBtn" title="撤销 (Ctrl+Z)" aria-label="撤销">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="toolbar-btn" id="redoBtn" title="重做 (Ctrl+Y)" aria-label="重做">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="toolbar-btn" id="loadDraftBtn" title="加载草稿" aria-label="加载草稿">
                    <i class="fas fa-folder-open"></i>
                </button>
                <button class="toolbar-btn" id="saveDraftBtn" title="保存草稿" aria-label="保存草稿">
                    <i class="fas fa-save"></i>
                </button>
                <button class="toolbar-btn" id="resetBtn" title="重置" aria-label="重置">
                    <i class="fas fa-sync"></i>
                </button>
            </div>

            <!-- 模板选择 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="templates">
                    <span><i class="fas fa-palette" style="color: #8b5cf6;"></i> 快速模板</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content expanded" id="templates">
                    <div class="collapsible-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                            <div class="template-card" data-template="simple">
                                <div style="font-size: 12px; font-weight: 500;">简约风</div>
                            </div>
                            <div class="template-card" data-template="vintage">
                                <div style="font-size: 12px; font-weight: 500;">复古风</div>
                            </div>
                            <div class="template-card" data-template="elegant">
                                <div style="font-size: 12px; font-weight: 500;">优雅风</div>
                            </div>
                            <div class="template-card" data-template="modern">
                                <div style="font-size: 12px; font-weight: 500;">现代风</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 内容编辑 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="content">
                    <span><i class="fas fa-edit" style="color: #3b82f6;"></i> 内容编辑</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content expanded" id="content">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-input" id="titleInput" placeholder="输入标题（可选）">
                        </div>
                        <div class="form-group">
                            <label class="form-label">正文 <span style="color: #ef4444;">*</span></label>
                            <textarea class="form-textarea" id="contentInput" rows="6" placeholder="输入格言正文（支持换行）" required></textarea>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 0.25rem;">
                                字数: <span id="charCount">0</span>/500
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">作者</label>
                            <input type="text" class="form-input" id="authorInput" placeholder="输入作者（可选）">
                        </div>
                        <div class="form-group">
                            <label class="form-label">注释</label>
                            <textarea class="form-textarea" id="noteInput" rows="2" placeholder="输入注释（可选）"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 画布尺寸 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="canvas">
                    <span><i class="fas fa-crop-alt" style="color: #10b981;"></i> 画布尺寸</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content expanded" id="canvas">
                    <div class="collapsible-body">
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 0.5rem;">微信专用</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                <button class="size-preset active" data-width="1080" data-height="1080" data-name="朋友圈单图">
                                    朋友圈单图<br><small>1:1</small>
                                </button>
                                <button class="size-preset" data-width="1080" data-height="1350" data-name="朋友圈多图">
                                    朋友圈多图<br><small>4:5</small>
                                </button>
                                <button class="size-preset" data-width="1080" data-height="1920" data-name="朋友圈全屏">
                                    朋友圈全屏<br><small>9:16</small>
                                </button>
                                <button class="size-preset" data-width="1080" data-height="1260" data-name="视频号封面">
                                    视频号封面<br><small>6:7</small>
                                </button>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 0.5rem;">通用尺寸</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                <button class="size-preset" data-width="800" data-height="800" data-name="方形">
                                    方形<br><small>1:1</small>
                                </button>
                                <button class="size-preset" data-width="1080" data-height="1440" data-name="竖版">
                                    竖版<br><small>3:4</small>
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; font-size: 13px; color: #1e40af;">
                            <i class="fas fa-info-circle"></i> 当前: <span id="currentSize">1080 × 1080 px</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文本样式 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="style">
                    <span><i class="fas fa-font" style="color: #8b5cf6;"></i> 文本样式</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content expanded" id="style">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label class="form-label">选择元素</label>
                            <select class="form-select" id="elementSelector">
                                <option value="title">标题</option>
                                <option value="content" selected>正文</option>
                                <option value="author">作者</option>
                                <option value="note">注释</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">字体</label>
                            <select class="form-select" id="fontFamily">
                                <optgroup label="中文字体">
                                    <option value="'Noto Serif SC', serif">思源宋体</option>
                                    <option value="'Ma Shan Zheng', cursive">马善政体</option>
                                    <option value="'ZCOOL QingKe HuangYou', sans-serif">站酷庆科黄油体</option>
                                    <option value="KaiTi, '楷体', cursive">楷体</option>
                                    <option value="SimSun, '宋体', serif">宋体</option>
                                    <option value="SimHei, '黑体', sans-serif">黑体</option>
                                    <option value="'Microsoft YaHei', '微软雅黑', sans-serif">微软雅黑</option>
                                    <option value="FangSong, '仿宋', serif">仿宋</option>
                                    <option value="STKaiti, '华文楷体', cursive">华文楷体</option>
                                    <option value="STSong, '华文宋体', serif">华文宋体</option>
                                    <option value="STHeiti, '华文黑体', sans-serif">华文黑体</option>
                                </optgroup>
                                <optgroup label="英文字体">
                                    <option value="'Georgia', serif">Georgia</option>
                                    <option value="'Times New Roman', serif">Times New Roman</option>
                                    <option value="'Palatino', serif">Palatino</option>
                                    <option value="'Garamond', serif">Garamond</option>
                                    <option value="'Arial', sans-serif">Arial</option>
                                    <option value="'Helvetica', sans-serif">Helvetica</option>
                                    <option value="'Verdana', sans-serif">Verdana</option>
                                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                                    <option value="'Courier New', monospace">Courier New</option>
                                    <option value="'Lucida Console', monospace">Lucida Console</option>
                                    <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                    <option value="'Impact', sans-serif">Impact</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">对齐方式</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="toolbar-btn text-align-btn active" data-align="left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button class="toolbar-btn text-align-btn" data-align="center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button class="toolbar-btn text-align-btn" data-align="right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">字体大小</label>
                            <div class="slider-group">
                                <input type="range" class="slider" id="fontSize" min="12" max="72" value="24">
                                <span id="fontSizeValue" style="min-width: 45px; text-align: right; font-size: 14px;">24px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">行间距</label>
                            <div class="slider-group">
                                <input type="range" class="slider" id="lineHeight" min="100" max="300" value="160">
                                <span id="lineHeightValue" style="min-width: 45px; text-align: right; font-size: 14px;">160%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">字间距</label>
                            <div class="slider-group">
                                <input type="range" class="slider" id="letterSpacing" min="-2" max="10" value="0" step="0.5">
                                <span id="letterSpacingValue" style="min-width: 45px; text-align: right; font-size: 14px;">0px</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">字体颜色</label>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="color" id="fontColor" value="#333333" style="width: 50px; height: 40px; cursor: pointer; border: 1px solid #d1d5db; border-radius: 6px;">
                                <input type="text" class="form-input" id="fontColorText" value="#333333" style="flex: 1;">
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.25rem;">
                                <div class="color-preset" style="background: #000000;" data-color="#000000"></div>
                                <div class="color-preset" style="background: #333333;" data-color="#333333"></div>
                                <div class="color-preset" style="background: #666666;" data-color="#666666"></div>
                                <div class="color-preset" style="background: #999999;" data-color="#999999"></div>
                                <div class="color-preset" style="background: #dc2626;" data-color="#dc2626"></div>
                                <div class="color-preset" style="background: #ea580c;" data-color="#ea580c"></div>
                                <div class="color-preset" style="background: #10b981;" data-color="#10b981"></div>
                                <div class="color-preset" style="background: #3b82f6;" data-color="#3b82f6"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="enableStroke" style="width: 18px; height: 18px; cursor: pointer;">
                                <label class="form-label" style="margin: 0; cursor: pointer;" for="enableStroke">字体描边</label>
                            </div>
                            <div id="strokeControls" style="display: none; padding-left: 1.5rem;">
                                <div class="form-group">
                                    <label class="form-label">描边颜色</label>
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="color" id="strokeColor" value="#ffffff" style="width: 50px; height: 40px; cursor: pointer; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <input type="text" class="form-input" id="strokeColorText" value="#ffffff" style="flex: 1;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">描边宽度</label>
                                    <div class="slider-group">
                                        <input type="range" class="slider" id="strokeWidth" min="0" max="10" value="2" step="0.5">
                                        <span id="strokeWidthValue" style="min-width: 45px; text-align: right; font-size: 14px;">2px</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 背景设置 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="background">
                    <span><i class="fas fa-image" style="color: #ef4444;"></i> 背景设置</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content expanded" id="background">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" id="bgTypeColor" style="flex: 1;">纯色</button>
                                <button class="btn btn-ghost" id="bgTypeImage" style="flex: 1;">图片</button>
                            </div>
                        </div>
                        <div id="colorBgSection">
                            <div class="form-group">
                                <label class="form-label">背景颜色</label>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <input type="color" id="bgColor" value="#f8fafc" style="width: 50px; height: 40px; cursor: pointer; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <input type="text" class="form-input" id="bgColorText" value="#f8fafc" style="flex: 1;">
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.25rem;">
                                    <div class="color-preset" style="background: #ffffff;" data-color="#ffffff"></div>
                                    <div class="color-preset" style="background: #f8fafc;" data-color="#f8fafc"></div>
                                    <div class="color-preset" style="background: #fef2f2;" data-color="#fef2f2"></div>
                                    <div class="color-preset" style="background: #fff7ed;" data-color="#fff7ed"></div>
                                    <div class="color-preset" style="background: #fffbeb;" data-color="#fffbeb"></div>
                                    <div class="color-preset" style="background: #f0fdf4;" data-color="#f0fdf4"></div>
                                    <div class="color-preset" style="background: #eff6ff;" data-color="#eff6ff"></div>
                                    <div class="color-preset" style="background: #000000;" data-color="#000000"></div>
                                </div>
                            </div>
                        </div>
                        <div id="imageBgSection" style="display: none;">
                            <div class="form-group">
                                <input type="file" id="bgImageUpload" accept="image/*" style="display: none;">
                                <button class="btn btn-primary" id="uploadBgBtn" style="width: 100%;">
                                    <i class="fas fa-upload"></i> 上传图片
                                </button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">平铺方式</label>
                                <select class="form-select" id="bgSize">
                                    <option value="cover">覆盖 (Cover)</option>
                                    <option value="contain">包含 (Contain)</option>
                                    <option value="auto">原始大小 (Auto)</option>
                                    <option value="100% 100%">拉伸 (Stretch)</option>
                                    <option value="custom">自定义百分比</option>
                                </select>
                            </div>
                            <div class="form-group" id="customSizeGroup" style="display: none;">
                                <label class="form-label">自定义尺寸</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280;">宽度 (%)</label>
                                        <input type="number" class="form-input" id="bgSizeWidth" value="100" min="1" max="500" step="5" style="margin-top: 0.25rem;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280;">高度 (%)</label>
                                        <input type="number" class="form-input" id="bgSizeHeight" value="100" min="1" max="500" step="5" style="margin-top: 0.25rem;">
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="bgSizeAspectRatio" checked style="width: 16px; height: 16px;">
                                        <span style="font-size: 13px; color: #6b7280;">保持宽高比</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">图片位置</label>
                                <select class="form-select" id="bgPosition">
                                    <option value="center center">居中</option>
                                    <option value="top center">上中</option>
                                    <option value="bottom center">下中</option>
                                    <option value="center left">左中</option>
                                    <option value="center right">右中</option>
                                    <option value="top left">左上</option>
                                    <option value="top right">右上</option>
                                    <option value="bottom left">左下</option>
                                    <option value="bottom right">右下</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">图片重复</label>
                                <select class="form-select" id="bgRepeat">
                                    <option value="no-repeat">不重复</option>
                                    <option value="repeat">平铺</option>
                                    <option value="repeat-x">横向平铺</option>
                                    <option value="repeat-y">纵向平铺</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">透明度</label>
                            <div class="slider-group">
                                <input type="range" class="slider" id="bgOpacity" min="0" max="100" value="100">
                                <span id="bgOpacityValue" style="min-width: 45px; text-align: right; font-size: 14px;">100%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文字高亮工具 -->
            <div class="collapsible-section">
                <div class="collapsible-header" data-target="highlighter">
                    <span><i class="fas fa-highlighter" style="color: #f59e0b;"></i> 文字高亮</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="collapsible-content" id="highlighter">
                    <div class="collapsible-body">
                        <div class="form-group">
                            <label class="form-label">使用说明</label>
                            <div style="padding: 0.75rem; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #92400e; margin-bottom: 1rem;">
                                <i class="fas fa-info-circle"></i> 在预览区选中文字后，点击颜色按钮即可高亮
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">高亮颜色</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                <button class="highlight-color-btn" data-color="#fef08a" style="background: #fef08a; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="黄色高亮"></button>
                                <button class="highlight-color-btn" data-color="#fecaca" style="background: #fecaca; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="红色高亮"></button>
                                <button class="highlight-color-btn" data-color="#bfdbfe" style="background: #bfdbfe; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="蓝色高亮"></button>
                                <button class="highlight-color-btn" data-color="#bbf7d0" style="background: #bbf7d0; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="绿色高亮"></button>
                                <button class="highlight-color-btn" data-color="#e9d5ff" style="background: #e9d5ff; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="紫色高亮"></button>
                                <button class="highlight-color-btn" data-color="#fed7aa" style="background: #fed7aa; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="橙色高亮"></button>
                                <button class="highlight-color-btn" data-color="#fbcfe8" style="background: #fbcfe8; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="粉色高亮"></button>
                                <button class="highlight-color-btn" data-color="#d1d5db" style="background: #d1d5db; padding: 1.5rem; border-radius: 6px; border: 2px solid #e5e7eb; cursor: pointer;" title="灰色高亮"></button>
                            </div>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-ghost" id="clearHighlights" style="width: 100%; justify-content: center;">
                                <i class="fas fa-eraser"></i> 清除所有高亮
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 导出按钮 -->
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-success" id="exportBtn" style="width: 100%; justify-content: center; padding: 0.75rem;">
                    <i class="fas fa-download"></i> 导出图片
                </button>
            </div>
        </div>

        <!-- 预览面板 -->
        <div class="preview-panel">
            <div class="preview-header">
                <div>
                    <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #111827;">
                        <i class="fas fa-eye" style="color: #8b5cf6;"></i> 实时预览
                    </h2>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-ghost" id="zoomOut" title="缩小">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="btn btn-ghost" id="resetZoom" title="重置">
                        <span id="zoomLevel">100%</span>
                    </button>
                    <button class="btn btn-ghost" id="zoomIn" title="放大">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="preview-content">
                <div class="canvas-wrapper" id="canvasWrapper">
                    <div class="canvas-container" id="cardCanvas">
                        <div class="canvas-background" id="cardBackground"></div>
                        <div class="canvas-content" id="cardContent">
                            <div class="text-element" id="titleElement" style="display: none; font-size: 32px; color: #333; font-family: 'Noto Serif SC', serif;"></div>
                            <div class="text-element" id="contentElement" style="font-size: 24px; color: #333; font-family: 'Noto Serif SC', serif; line-height: 1.6; user-select: text; cursor: text;">请输入格言正文</div>
                            <div class="text-element" id="authorElement" style="display: none; font-size: 18px; color: #666; font-family: 'Noto Serif SC', serif;"></div>
                            <div class="text-element" id="noteElement" style="display: none; font-size: 16px; color: #888; font-family: 'Noto Serif SC', serif;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== 工具函数模块 ==========
        const Utils = {
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },

            rgbToHex(rgb) {
                if (!rgb || rgb.startsWith('#')) return rgb || '#333333';
                const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                if (!match) return '#333333';
                const [, r, g, b] = match;
                return '#' + [r, g, b].map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
            },

            hexToRgba(hex, alpha = 1) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            },

            formatDate() {
                const now = new Date();
                return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            },

            validateContent(content) {
                if (!content.trim()) {
                    return { valid: false, message: '正文不能为空' };
                }
                if (content.length > 500) {
                    return { valid: false, message: '正文过长，建议500字以内' };
                }
                if (content.trim().length < 3) {
                    return { valid: false, message: '正文内容过短' };
                }
                return { valid: true };
            }
        };

        // ========== Toast通知模块 ==========
        const Toast = {
            show(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    info: 'fa-info-circle'
                };
                
                toast.innerHTML = `
                    <i class="fas ${icons[type]}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            info(message) { this.show(message, 'info'); }
        };

        // ========== 历史记录模块 ==========
        const History = {
            states: [],
            currentIndex: -1,
            maxStates: 20,

            push(state) {
                this.states = this.states.slice(0, this.currentIndex + 1);
                this.states.push(JSON.parse(JSON.stringify(state)));
                if (this.states.length > this.maxStates) {
                    this.states.shift();
                } else {
                    this.currentIndex++;
                }
                this.updateButtons();
            },

            undo() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    return this.states[this.currentIndex];
                }
                return null;
            },

            redo() {
                if (this.currentIndex < this.states.length - 1) {
                    this.currentIndex++;
                    return this.states[this.currentIndex];
                }
                return null;
            },

            canUndo() {
                return this.currentIndex > 0;
            },

            canRedo() {
                return this.currentIndex < this.states.length - 1;
            },

            updateButtons() {
                const undoBtn = document.getElementById('undoBtn');
                const redoBtn = document.getElementById('redoBtn');
                undoBtn.disabled = !this.canUndo();
                redoBtn.disabled = !this.canRedo();
                undoBtn.style.opacity = this.canUndo() ? '1' : '0.5';
                redoBtn.style.opacity = this.canRedo() ? '1' : '0.5';
            },

            clear() {
                this.states = [];
                this.currentIndex = -1;
                this.updateButtons();
            }
        };

        // ========== 画布管理模块 ==========
        const CanvasManager = {
            width: 1080,
            height: 1080,
            sizeName: '朋友圈单图',
            zoom: 1,

            updateSize(width, height, name) {
                this.width = width;
                this.height = height;
                this.sizeName = name;

                const canvas = document.getElementById('cardCanvas');
                
                // 计算预览尺寸（最大750px）
                const maxPreviewSize = 750;
                const aspectRatio = width / height;
                let previewWidth, previewHeight;

                if (aspectRatio > 1) {
                    previewWidth = Math.min(maxPreviewSize, width);
                    previewHeight = previewWidth / aspectRatio;
                } else {
                    previewHeight = Math.min(maxPreviewSize, height);
                    previewWidth = previewHeight * aspectRatio;
                }

                canvas.style.width = `${previewWidth}px`;
                canvas.style.height = `${previewHeight}px`;

                // 更新显示信息
                document.getElementById('currentSize').textContent = `${width} × ${height} px`;

                // 调整内容布局
                this.adjustLayout();
                
                App.saveState();
            },

            adjustLayout() {
                const contentContainer = document.getElementById('cardContent');
                const basePadding = 60;
                const paddingScale = Math.min(this.width, this.height) / 1080;
                const padding = Math.max(basePadding * paddingScale, 40);
                contentContainer.style.padding = `${padding}px`;
            },

            setZoom(zoom) {
                this.zoom = Math.max(0.5, Math.min(2, zoom));
                const wrapper = document.getElementById('canvasWrapper');
                wrapper.style.transform = `scale(${this.zoom})`;
                document.getElementById('zoomLevel').textContent = `${Math.round(this.zoom * 100)}%`;
            },

            zoomIn() {
                this.setZoom(this.zoom + 0.1);
            },

            zoomOut() {
                this.setZoom(this.zoom - 0.1);
            },

            resetZoom() {
                this.setZoom(1);
            }
        };

        // ========== 样式管理模块 ==========
        const StyleManager = {
            currentElement: null,
            currentAlign: 'left',

            init() {
                this.currentElement = document.getElementById('contentElement');
            },

            selectElement(elementId) {
                this.currentElement = document.getElementById(elementId + 'Element');
                this.updateControls();
            },

            updateControls() {
                const el = this.currentElement;
                if (!el) return;

                document.getElementById('fontFamily').value = el.style.fontFamily || "'Noto Serif SC', serif";
                document.getElementById('fontSize').value = parseInt(el.style.fontSize) || 24;
                document.getElementById('lineHeight').value = Math.round(parseFloat(el.style.lineHeight || 1.6) * 100);
                document.getElementById('letterSpacing').value = parseFloat(el.style.letterSpacing) || 0;
                document.getElementById('fontColor').value = Utils.rgbToHex(el.style.color);
                document.getElementById('fontColorText').value = Utils.rgbToHex(el.style.color);

                // 检查描边
                const hasStroke = el.style.webkitTextStroke && el.style.webkitTextStroke !== '';
                document.getElementById('enableStroke').checked = hasStroke;
                document.getElementById('strokeControls').style.display = hasStroke ? 'block' : 'none';

                if (hasStroke) {
                    const strokeParts = el.style.webkitTextStroke.split(' ');
                    if (strokeParts.length >= 2) {
                        document.getElementById('strokeWidth').value = parseFloat(strokeParts[0]);
                        document.getElementById('strokeColor').value = Utils.rgbToHex(strokeParts[1]);
                        document.getElementById('strokeColorText').value = Utils.rgbToHex(strokeParts[1]);
                    }
                }

                this.updateValueDisplays();
            },

            updateValueDisplays() {
                document.getElementById('fontSizeValue').textContent = document.getElementById('fontSize').value + 'px';
                document.getElementById('lineHeightValue').textContent = document.getElementById('lineHeight').value + '%';
                document.getElementById('letterSpacingValue').textContent = document.getElementById('letterSpacing').value + 'px';
                
                const strokeWidthEl = document.getElementById('strokeWidthValue');
                if (strokeWidthEl) {
                    strokeWidthEl.textContent = document.getElementById('strokeWidth').value + 'px';
                }
            },

            applyStyle() {
                if (!this.currentElement) return;

                const el = this.currentElement;
                el.style.fontFamily = document.getElementById('fontFamily').value;
                el.style.fontSize = document.getElementById('fontSize').value + 'px';
                el.style.lineHeight = document.getElementById('lineHeight').value / 100;
                el.style.letterSpacing = document.getElementById('letterSpacing').value + 'px';
                el.style.color = document.getElementById('fontColor').value;
                el.style.textAlign = this.currentAlign;

                // 应用描边
                const enableStroke = document.getElementById('enableStroke').checked;
                if (enableStroke) {
                    const strokeWidth = document.getElementById('strokeWidth').value;
                    const strokeColor = document.getElementById('strokeColor').value;
                    el.style.webkitTextStroke = `${strokeWidth}px ${strokeColor}`;
                    el.style.paintOrder = 'stroke fill';
                } else {
                    el.style.webkitTextStroke = '';
                    el.style.paintOrder = '';
                }

                App.saveState();
            },

            setAlignment(align) {
                this.currentAlign = align;
                document.querySelectorAll('.text-align-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.align === align);
                });
                if (this.currentElement) {
                    this.currentElement.style.textAlign = align;
                    App.saveState();
                }
            }
        };

        // ========== 背景管理模块 ==========
        const BackgroundManager = {
            type: 'color',
            currentImage: null,
            bgSize: 'cover',
            bgPosition: 'center center',
            bgRepeat: 'no-repeat',
            customSizeWidth: 100,
            customSizeHeight: 100,

            setType(type) {
                this.type = type;
                document.getElementById('bgTypeColor').className = type === 'color' ? 'btn btn-primary' : 'btn btn-ghost';
                document.getElementById('bgTypeImage').className = type === 'image' ? 'btn btn-primary' : 'btn btn-ghost';
                document.getElementById('colorBgSection').style.display = type === 'color' ? 'block' : 'none';
                document.getElementById('imageBgSection').style.display = type === 'image' ? 'block' : 'none';

                if (type === 'color') {
                    this.applyColor();
                } else {
                    this.applyImage();
                }
            },

            applyColor() {
                const bg = document.getElementById('cardBackground');
                const color = document.getElementById('bgColor').value;
                const opacity = document.getElementById('bgOpacity').value / 100;
                
                bg.style.backgroundColor = color;
                bg.style.backgroundImage = 'none';
                bg.style.opacity = opacity;
                
                App.saveState();
            },

            applyImage() {
                const bg = document.getElementById('cardBackground');
                const opacity = document.getElementById('bgOpacity').value / 100;
                
                if (this.currentImage) {
                    bg.style.backgroundImage = `url(${this.currentImage})`;
                    bg.style.backgroundColor = 'transparent';
                    
                    // 处理自定义尺寸
                    let sizeValue = this.bgSize;
                    if (this.bgSize === 'custom') {
                        sizeValue = `${this.customSizeWidth}% ${this.customSizeHeight}%`;
                    }
                    
                    bg.style.backgroundSize = sizeValue;
                    bg.style.backgroundPosition = this.bgPosition;
                    bg.style.backgroundRepeat = this.bgRepeat;
                    bg.style.opacity = opacity;
                }
            },

            uploadImage(file) {
                if (!file || !file.type.startsWith('image/')) {
                    Toast.error('请选择有效的图片文件');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.currentImage = e.target.result;
                    this.applyImage();
                    Toast.success('背景图片已上传');
                    App.saveState();
                };
                reader.readAsDataURL(file);
            },

            updateImageSettings() {
                const sizeSelect = document.getElementById('bgSize');
                this.bgSize = sizeSelect.value;
                this.bgPosition = document.getElementById('bgPosition').value;
                this.bgRepeat = document.getElementById('bgRepeat').value;
                
                // 显示/隐藏自定义尺寸输入框
                const customSizeGroup = document.getElementById('customSizeGroup');
                customSizeGroup.style.display = this.bgSize === 'custom' ? 'block' : 'none';
                
                this.applyImage();
                App.saveState();
            },

            updateCustomSize() {
                const width = parseInt(document.getElementById('bgSizeWidth').value) || 100;
                const height = parseInt(document.getElementById('bgSizeHeight').value) || 100;
                const keepAspectRatio = document.getElementById('bgSizeAspectRatio').checked;
                
                this.customSizeWidth = width;
                this.customSizeHeight = height;
                
                this.applyImage();
                App.saveState();
            },

            syncAspectRatio(changedInput) {
                const keepAspectRatio = document.getElementById('bgSizeAspectRatio').checked;
                if (!keepAspectRatio) return;
                
                const widthInput = document.getElementById('bgSizeWidth');
                const heightInput = document.getElementById('bgSizeHeight');
                
                if (changedInput === 'width') {
                    heightInput.value = widthInput.value;
                } else {
                    widthInput.value = heightInput.value;
                }
                
                this.updateCustomSize();
            },

            updateOpacity() {
                const opacity = document.getElementById('bgOpacity').value / 100;
                document.getElementById('cardBackground').style.opacity = opacity;
                document.getElementById('bgOpacityValue').textContent = document.getElementById('bgOpacity').value + '%';
                App.saveState();
            }
        };

        // ========== 文字高亮模块 ==========
        const Highlighter = {
            highlights: new Map(), // 存储高亮信息

            init() {
                // 监听文本选择
                document.addEventListener('mouseup', () => {
                    const selection = window.getSelection();
                    if (selection.toString().trim().length > 0) {
                        const range = selection.getRangeAt(0);
                        const container = range.commonAncestorContainer.parentElement;
                        
                        // 确保选中的是文本元素
                        if (container && container.classList.contains('text-element')) {
                            // 选择已保存，等待用户点击颜色按钮
                        }
                    }
                });
            },

            applyHighlight(color) {
                const selection = window.getSelection();
                if (!selection.toString().trim()) {
                    Toast.info('请先选中要高亮的文字');
                    return;
                }

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer.parentElement;
                
                // 确保选中的是文本元素
                if (!container || !container.classList.contains('text-element')) {
                    Toast.error('请在预览区域选中文字');
                    return;
                }

                // 创建高亮标记
                const span = document.createElement('span');
                span.style.backgroundColor = color;
                span.style.padding = '0.1em 0';
                span.style.borderRadius = '2px';
                span.style.display = 'inline';
                span.style.lineHeight = 'inherit';
                span.className = 'highlight-mark';
                
                try {
                    range.surroundContents(span);
                    selection.removeAllRanges();
                    Toast.success('高亮已应用');
                    App.saveState();
                } catch (e) {
                    // 如果选择跨越了多个节点，使用另一种方法
                    try {
                        const fragment = range.extractContents();
                        span.appendChild(fragment);
                        range.insertNode(span);
                        selection.removeAllRanges();
                        Toast.success('高亮已应用');
                        App.saveState();
                    } catch (err) {
                        Toast.error('无法应用高亮，请重新选择');
                    }
                }
            },

            clear() {
                const marks = document.querySelectorAll('.highlight-mark');
                marks.forEach(mark => {
                    const parent = mark.parentNode;
                    while (mark.firstChild) {
                        parent.insertBefore(mark.firstChild, mark);
                    }
                    parent.removeChild(mark);
                });
                
                // 合并相邻的文本节点
                document.querySelectorAll('.text-element').forEach(el => {
                    el.normalize();
                });
                
                Toast.success('已清除所有高亮');
                App.saveState();
            },

            getHighlightedHTML(elementId) {
                const element = document.getElementById(elementId + 'Element');
                return element ? element.innerHTML : '';
            },

            restoreHighlights(elementId, html) {
                const element = document.getElementById(elementId + 'Element');
                if (element && html) {
                    element.innerHTML = html;
                }
            }
        };

        // ========== 模板管理模块 ==========
        const Templates = {
            presets: {
                simple: {
                    name: '简约风',
                    bgColor: '#ffffff',
                    fontFamily: "'Noto Serif SC', serif",
                    fontColor: '#333333',
                    fontSize: 24
                },
                vintage: {
                    name: '复古风',
                    bgColor: '#f5f5dc',
                    fontFamily: "KaiTi, cursive",
                    fontColor: '#8b4513',
                    fontSize: 26
                },
                elegant: {
                    name: '优雅风',
                    bgColor: '#faf5ff',
                    fontFamily: "'Ma Shan Zheng', cursive",
                    fontColor: '#6b21a8',
                    fontSize: 28
                },
                modern: {
                    name: '现代风',
                    bgColor: '#0f172a',
                    fontFamily: "'ZCOOL QingKe HuangYou', sans-serif",
                    fontColor: '#ffffff',
                    fontSize: 30
                }
            },

            apply(templateName) {
                const template = this.presets[templateName];
                if (!template) return;

                // 应用背景
                BackgroundManager.setType('color');
                document.getElementById('bgColor').value = template.bgColor;
                document.getElementById('bgColorText').value = template.bgColor;
                BackgroundManager.applyColor();

                // 应用到正文
                StyleManager.selectElement('content');
                document.getElementById('fontFamily').value = template.fontFamily;
                document.getElementById('fontSize').value = template.fontSize;
                document.getElementById('fontColor').value = template.fontColor;
                document.getElementById('fontColorText').value = template.fontColor;
                StyleManager.applyStyle();

                Toast.success(`已应用 ${template.name} 模板`);
            }
        };

        // ========== 导出模块 ==========
        const Exporter = {
            async export() {
                // 验证内容
                const content = document.getElementById('contentInput').value;
                const validation = Utils.validateContent(content);
                
                if (!validation.valid) {
                    Toast.error(validation.message);
                    return;
                }

                Toast.info('正在生成图片...');

                try {
                    // 创建导出容器
                    const exportCanvas = this.createExportCanvas();
                    document.body.appendChild(exportCanvas);

                    // 等待字体加载
                    await document.fonts.ready;

                    // 生成图片
                    const canvas = await html2canvas(exportCanvas, {
                        scale: 1,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null,
                        width: CanvasManager.width,
                        height: CanvasManager.height,
                        logging: false
                    });

                    // 下载
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `格言卡片_${Utils.formatDate()}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        Toast.success('图片导出成功！');
                    }, 'image/png', 1.0);

                    // 清理
                    document.body.removeChild(exportCanvas);

                } catch (error) {
                    console.error('导出失败:', error);
                    Toast.error('导出失败，请重试');
                }
            },

            createExportCanvas() {
                const container = document.createElement('div');
                container.style.cssText = `
                    position: fixed;
                    left: -9999px;
                    top: -9999px;
                    width: ${CanvasManager.width}px;
                    height: ${CanvasManager.height}px;
                `;

                const original = document.getElementById('cardCanvas');
                const clone = original.cloneNode(true);
                clone.style.width = `${CanvasManager.width}px`;
                clone.style.height = `${CanvasManager.height}px`;
                clone.style.transform = 'none';

                // 调整内容容器的padding（按实际画布尺寸）
                const cloneContent = clone.querySelector('#cardContent');
                const basePadding = 60;
                const paddingScale = Math.min(CanvasManager.width, CanvasManager.height) / 1080;
                const padding = Math.max(basePadding * paddingScale, 40);
                cloneContent.style.padding = `${padding}px`;

                // 调整文本元素字体大小（按实际画布尺寸）
                const fontScale = Math.min(CanvasManager.width, CanvasManager.height) / 750;
                const textElements = clone.querySelectorAll('.text-element');
                textElements.forEach(el => {
                    if (el.style.fontSize) {
                        const currentSize = parseFloat(el.style.fontSize);
                        el.style.fontSize = `${currentSize * fontScale}px`;
                    }
                    // 保持高亮样式
                    el.style.userSelect = 'none';
                    el.style.cursor = 'default';
                });

                container.appendChild(clone);
                return container;
            }
        };

        // ========== 草稿管理模块 ==========
        const DraftManager = {
            key: 'quoteCardDraft_v2',

            save() {
                try {
                    const draft = {
                        content: {
                            title: document.getElementById('titleInput').value,
                            text: document.getElementById('contentInput').value,
                            author: document.getElementById('authorInput').value,
                            note: document.getElementById('noteInput').value
                        },
                        canvas: {
                            width: CanvasManager.width,
                            height: CanvasManager.height,
                            sizeName: CanvasManager.sizeName
                        },
                        style: {
                            fontFamily: document.getElementById('fontFamily').value,
                            fontSize: document.getElementById('fontSize').value,
                            lineHeight: document.getElementById('lineHeight').value,
                            letterSpacing: document.getElementById('letterSpacing').value,
                            fontColor: document.getElementById('fontColor').value,
                            textAlign: StyleManager.currentAlign
                        },
                        background: {
                            type: BackgroundManager.type,
                            color: document.getElementById('bgColor').value,
                            opacity: document.getElementById('bgOpacity').value,
                            image: BackgroundManager.currentImage,
                            size: BackgroundManager.bgSize,
                            position: BackgroundManager.bgPosition,
                            repeat: BackgroundManager.bgRepeat,
                            customSizeWidth: BackgroundManager.customSizeWidth,
                            customSizeHeight: BackgroundManager.customSizeHeight
                        },
                        highlights: {
                            title: Highlighter.getHighlightedHTML('title'),
                            content: Highlighter.getHighlightedHTML('content'),
                            author: Highlighter.getHighlightedHTML('author'),
                            note: Highlighter.getHighlightedHTML('note')
                        },
                        timestamp: new Date().toISOString()
                    };

                    localStorage.setItem(this.key, JSON.stringify(draft));
                    Toast.success('草稿已保存');
                } catch (error) {
                    console.error('保存草稿失败:', error);
                    Toast.error('保存草稿失败');
                }
            },

            load() {
                try {
                    const data = localStorage.getItem(this.key);
                    if (!data) {
                        Toast.info('没有找到保存的草稿');
                        return false;
                    }

                    const draft = JSON.parse(data);

                    // 恢复内容
                    document.getElementById('titleInput').value = draft.content.title || '';
                    document.getElementById('contentInput').value = draft.content.text || '';
                    document.getElementById('authorInput').value = draft.content.author || '';
                    document.getElementById('noteInput').value = draft.content.note || '';

                    // 恢复画布
                    CanvasManager.updateSize(draft.canvas.width, draft.canvas.height, draft.canvas.sizeName);

                    // 恢复样式
                    document.getElementById('fontFamily').value = draft.style.fontFamily;
                    document.getElementById('fontSize').value = draft.style.fontSize;
                    document.getElementById('lineHeight').value = draft.style.lineHeight;
                    document.getElementById('letterSpacing').value = draft.style.letterSpacing;
                    document.getElementById('fontColor').value = draft.style.fontColor;
                    document.getElementById('fontColorText').value = draft.style.fontColor;
                    StyleManager.setAlignment(draft.style.textAlign);

                    // 恢复背景
                    BackgroundManager.setType(draft.background.type);
                    document.getElementById('bgColor').value = draft.background.color;
                    document.getElementById('bgColorText').value = draft.background.color;
                    document.getElementById('bgOpacity').value = draft.background.opacity;
                    
                    if (draft.background.image) {
                        BackgroundManager.currentImage = draft.background.image;
                        document.getElementById('cardBackground').style.backgroundImage = `url(${draft.background.image})`;
                    }

                    // 恢复高亮
                    if (draft.highlights) {
                        Highlighter.restoreHighlights('title', draft.highlights.title);
                        Highlighter.restoreHighlights('content', draft.highlights.content);
                        Highlighter.restoreHighlights('author', draft.highlights.author);
                        Highlighter.restoreHighlights('note', draft.highlights.note);
                    }

                    // 更新UI
                    App.updateContent();
                    StyleManager.updateControls();
                    BackgroundManager.applyColor();

                    const date = new Date(draft.timestamp).toLocaleString();
                    Toast.success(`草稿已加载 (${date})`);
                    return true;

                } catch (error) {
                    console.error('加载草稿失败:', error);
                    Toast.error('加载草稿失败');
                    return false;
                }
            },

            clear() {
                if (confirm('确定要清除保存的草稿吗？')) {
                    localStorage.removeItem(this.key);
                    Toast.success('草稿已清除');
                }
            }
        };

        // ========== 主应用模块 ==========
        const App = {
            init() {
                this.bindEvents();
                this.initCollapsible();
                StyleManager.init();
                Highlighter.init();
                History.updateButtons();
                
                // 尝试加载草稿
                setTimeout(() => {
                    const hasData = localStorage.getItem(DraftManager.key);
                    if (hasData) {
                        if (confirm('检测到未保存的草稿，是否加载？')) {
                            DraftManager.load();
                        }
                    }
                }, 500);

                // 保存初始状态
                this.saveState();

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') {
                            e.preventDefault();
                            this.undo();
                        } else if (e.key === 'y') {
                            e.preventDefault();
                            this.redo();
                        } else if (e.key === 's') {
                            e.preventDefault();
                            DraftManager.save();
                        }
                    }
                });
            },

            bindEvents() {
                // 内容输入
                ['titleInput', 'contentInput', 'authorInput', 'noteInput'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.updateContent();
                        this.autoSave();
                    });
                });

                // 字数统计
                document.getElementById('contentInput').addEventListener('input', (e) => {
                    document.getElementById('charCount').textContent = e.target.value.length;
                });

                // 画布尺寸
                document.querySelectorAll('.size-preset').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.size-preset').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        CanvasManager.updateSize(
                            parseInt(btn.dataset.width),
                            parseInt(btn.dataset.height),
                            btn.dataset.name
                        );
                    });
                });

                // 元素选择
                document.getElementById('elementSelector').addEventListener('change', (e) => {
                    StyleManager.selectElement(e.target.value);
                });

                // 文本样式
                ['fontFamily', 'fontSize', 'lineHeight', 'letterSpacing', 'fontColor'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        StyleManager.updateValueDisplays();
                        StyleManager.applyStyle();
                    });
                });

                document.getElementById('fontColorText').addEventListener('input', (e) => {
                    document.getElementById('fontColor').value = e.target.value;
                    StyleManager.applyStyle();
                });

                // 文本对齐
                document.querySelectorAll('.text-align-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        StyleManager.setAlignment(btn.dataset.align);
                    });
                });

                // 颜色预设
                document.querySelectorAll('#style .color-preset').forEach(preset => {
                    preset.addEventListener('click', () => {
                        const color = preset.dataset.color;
                        document.getElementById('fontColor').value = color;
                        document.getElementById('fontColorText').value = color;
                        StyleManager.applyStyle();
                    });
                });

                // 背景类型
                document.getElementById('bgTypeColor').addEventListener('click', () => {
                    BackgroundManager.setType('color');
                });
                document.getElementById('bgTypeImage').addEventListener('click', () => {
                    BackgroundManager.setType('image');
                });

                // 背景颜色
                document.getElementById('bgColor').addEventListener('input', (e) => {
                    document.getElementById('bgColorText').value = e.target.value;
                    BackgroundManager.applyColor();
                });
                document.getElementById('bgColorText').addEventListener('input', (e) => {
                    document.getElementById('bgColor').value = e.target.value;
                    BackgroundManager.applyColor();
                });

                // 背景颜色预设
                document.querySelectorAll('#background .color-preset').forEach(preset => {
                    preset.addEventListener('click', () => {
                        const color = preset.dataset.color;
                        document.getElementById('bgColor').value = color;
                        document.getElementById('bgColorText').value = color;
                        BackgroundManager.applyColor();
                    });
                });

                // 背景图片
                document.getElementById('uploadBgBtn').addEventListener('click', () => {
                    document.getElementById('bgImageUpload').click();
                });
                document.getElementById('bgImageUpload').addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        BackgroundManager.uploadImage(e.target.files[0]);
                    }
                });

                // 背景图片设置
                document.getElementById('bgSize').addEventListener('change', () => {
                    BackgroundManager.updateImageSettings();
                });
                document.getElementById('bgPosition').addEventListener('change', () => {
                    BackgroundManager.updateImageSettings();
                });
                document.getElementById('bgRepeat').addEventListener('change', () => {
                    BackgroundManager.updateImageSettings();
                });

                // 自定义尺寸
                document.getElementById('bgSizeWidth').addEventListener('input', () => {
                    BackgroundManager.syncAspectRatio('width');
                });
                document.getElementById('bgSizeHeight').addEventListener('input', () => {
                    BackgroundManager.syncAspectRatio('height');
                });
                document.getElementById('bgSizeAspectRatio').addEventListener('change', () => {
                    BackgroundManager.syncAspectRatio('width');
                });

                // 背景透明度
                document.getElementById('bgOpacity').addEventListener('input', () => {
                    BackgroundManager.updateOpacity();
                });

                // 字体描边
                document.getElementById('enableStroke').addEventListener('change', () => {
                    const enabled = document.getElementById('enableStroke').checked;
                    document.getElementById('strokeControls').style.display = enabled ? 'block' : 'none';
                    StyleManager.applyStyle();
                });
                document.getElementById('strokeColor').addEventListener('input', (e) => {
                    document.getElementById('strokeColorText').value = e.target.value;
                    StyleManager.applyStyle();
                });
                document.getElementById('strokeColorText').addEventListener('input', (e) => {
                    document.getElementById('strokeColor').value = e.target.value;
                    StyleManager.applyStyle();
                });
                document.getElementById('strokeWidth').addEventListener('input', () => {
                    StyleManager.updateValueDisplays();
                    StyleManager.applyStyle();
                });

                // 文字高亮
                document.querySelectorAll('.highlight-color-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        Highlighter.applyHighlight(btn.dataset.color);
                    });
                });
                document.getElementById('clearHighlights').addEventListener('click', () => {
                    Highlighter.clear();
                });

                // 模板
                document.querySelectorAll('.template-card').forEach(card => {
                    card.addEventListener('click', () => {
                        Templates.apply(card.dataset.template);
                    });
                });

                // 工具栏
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('redoBtn').addEventListener('click', () => this.redo());
                document.getElementById('loadDraftBtn').addEventListener('click', () => DraftManager.load());
                document.getElementById('saveDraftBtn').addEventListener('click', () => DraftManager.save());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());

                // 缩放
                document.getElementById('zoomIn').addEventListener('click', () => CanvasManager.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => CanvasManager.zoomOut());
                document.getElementById('resetZoom').addEventListener('click', () => CanvasManager.resetZoom());

                // 导出
                document.getElementById('exportBtn').addEventListener('click', () => Exporter.export());
            },

            initCollapsible() {
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        const target = document.getElementById(header.dataset.target);
                        const icon = header.querySelector('.fa-chevron-down');
                        
                        target.classList.toggle('expanded');
                        icon.style.transform = target.classList.contains('expanded') 
                            ? 'rotate(0deg)' 
                            : 'rotate(-90deg)';
                    });
                });
            },

            updateContent() {
                const title = document.getElementById('titleInput').value;
                const content = document.getElementById('contentInput').value;
                const author = document.getElementById('authorInput').value;
                const note = document.getElementById('noteInput').value;

                const titleEl = document.getElementById('titleElement');
                const contentEl = document.getElementById('contentElement');
                const authorEl = document.getElementById('authorElement');
                const noteEl = document.getElementById('noteElement');

                // 保存当前高亮
                const titleHighlight = Highlighter.getHighlightedHTML('title');
                const contentHighlight = Highlighter.getHighlightedHTML('content');
                const authorHighlight = Highlighter.getHighlightedHTML('author');
                const noteHighlight = Highlighter.getHighlightedHTML('note');

                // 更新文本内容（如果有高亮则保留）
                if (!titleHighlight || !titleEl.querySelector('.highlight-mark')) {
                    titleEl.textContent = title;
                }
                titleEl.style.display = title.trim() ? 'block' : 'none';

                if (!contentHighlight || !contentEl.querySelector('.highlight-mark')) {
                    contentEl.textContent = content || '请输入格言正文';
                }

                if (!authorHighlight || !authorEl.querySelector('.highlight-mark')) {
                    authorEl.textContent = author ? `—— ${author}` : '';
                }
                authorEl.style.display = author.trim() ? 'block' : 'none';

                if (!noteHighlight || !noteEl.querySelector('.highlight-mark')) {
                    noteEl.textContent = note;
                }
                noteEl.style.display = note.trim() ? 'block' : 'none';
            },

            saveState() {
                const state = {
                    content: {
                        title: document.getElementById('titleInput').value,
                        text: document.getElementById('contentInput').value,
                        author: document.getElementById('authorInput').value,
                        note: document.getElementById('noteInput').value
                    },
                    canvas: {
                        width: CanvasManager.width,
                        height: CanvasManager.height
                    },
                    style: {
                        fontFamily: document.getElementById('fontFamily').value,
                        fontSize: document.getElementById('fontSize').value,
                        lineHeight: document.getElementById('lineHeight').value,
                        letterSpacing: document.getElementById('letterSpacing').value,
                        fontColor: document.getElementById('fontColor').value,
                        align: StyleManager.currentAlign,
                        enableStroke: document.getElementById('enableStroke').checked,
                        strokeColor: document.getElementById('strokeColor').value,
                        strokeWidth: document.getElementById('strokeWidth').value
                    },
                    background: {
                        type: BackgroundManager.type,
                        color: document.getElementById('bgColor').value,
                        opacity: document.getElementById('bgOpacity').value,
                        image: BackgroundManager.currentImage,
                        size: BackgroundManager.bgSize,
                        position: BackgroundManager.bgPosition,
                        repeat: BackgroundManager.bgRepeat,
                        customSizeWidth: BackgroundManager.customSizeWidth,
                        customSizeHeight: BackgroundManager.customSizeHeight
                    },
                    highlights: {
                        title: Highlighter.getHighlightedHTML('title'),
                        content: Highlighter.getHighlightedHTML('content'),
                        author: Highlighter.getHighlightedHTML('author'),
                        note: Highlighter.getHighlightedHTML('note')
                    }
                };
                History.push(state);
            },

            restoreState(state) {
                if (!state) return;

                // 恢复内容
                document.getElementById('titleInput').value = state.content.title;
                document.getElementById('contentInput').value = state.content.text;
                document.getElementById('authorInput').value = state.content.author;
                document.getElementById('noteInput').value = state.content.note;

                // 恢复样式
                document.getElementById('fontFamily').value = state.style.fontFamily;
                document.getElementById('fontSize').value = state.style.fontSize;
                document.getElementById('lineHeight').value = state.style.lineHeight;
                document.getElementById('letterSpacing').value = state.style.letterSpacing;
                document.getElementById('fontColor').value = state.style.fontColor;
                document.getElementById('fontColorText').value = state.style.fontColor;
                StyleManager.setAlignment(state.style.align);
                
                if (state.style.enableStroke !== undefined) {
                    document.getElementById('enableStroke').checked = state.style.enableStroke;
                    document.getElementById('strokeControls').style.display = state.style.enableStroke ? 'block' : 'none';
                    if (state.style.enableStroke) {
                        document.getElementById('strokeColor').value = state.style.strokeColor;
                        document.getElementById('strokeColorText').value = state.style.strokeColor;
                        document.getElementById('strokeWidth').value = state.style.strokeWidth;
                    }
                }

                // 恢复背景
                BackgroundManager.setType(state.background.type);
                document.getElementById('bgColor').value = state.background.color;
                document.getElementById('bgColorText').value = state.background.color;
                document.getElementById('bgOpacity').value = state.background.opacity;
                
                if (state.background.image && state.background.type === 'image') {
                    BackgroundManager.currentImage = state.background.image;
                    BackgroundManager.bgSize = state.background.size || 'cover';
                    BackgroundManager.bgPosition = state.background.position || 'center center';
                    BackgroundManager.bgRepeat = state.background.repeat || 'no-repeat';
                    BackgroundManager.customSizeWidth = state.background.customSizeWidth || 100;
                    BackgroundManager.customSizeHeight = state.background.customSizeHeight || 100;
                    
                    document.getElementById('bgSize').value = BackgroundManager.bgSize;
                    document.getElementById('bgPosition').value = BackgroundManager.bgPosition;
                    document.getElementById('bgRepeat').value = BackgroundManager.bgRepeat;
                    document.getElementById('bgSizeWidth').value = BackgroundManager.customSizeWidth;
                    document.getElementById('bgSizeHeight').value = BackgroundManager.customSizeHeight;
                    
                    document.getElementById('customSizeGroup').style.display = 
                        BackgroundManager.bgSize === 'custom' ? 'block' : 'none';
                    
                    BackgroundManager.applyImage();
                }

                // 恢复高亮
                if (state.highlights) {
                    setTimeout(() => {
                        Highlighter.restoreHighlights('title', state.highlights.title);
                        Highlighter.restoreHighlights('content', state.highlights.content);
                        Highlighter.restoreHighlights('author', state.highlights.author);
                        Highlighter.restoreHighlights('note', state.highlights.note);
                    }, 100);
                }

                // 更新显示
                this.updateContent();
                StyleManager.updateControls();
                StyleManager.applyStyle();
                if (state.background.type === 'color') {
                    BackgroundManager.applyColor();
                }
            },

            undo() {
                const state = History.undo();
                if (state) {
                    this.restoreState(state);
                    Toast.info('已撤销');
                }
            },

            redo() {
                const state = History.redo();
                if (state) {
                    this.restoreState(state);
                    Toast.info('已重做');
                }
            },

            autoSave: Utils.debounce(() => {
                DraftManager.save();
            }, 3000),

            reset() {
                if (!confirm('确定要重置所有内容吗？这将清除当前的编辑内容。')) {
                    return;
                }

                // 重置内容
                document.getElementById('titleInput').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('authorInput').value = '';
                document.getElementById('noteInput').value = '';

                // 重置样式
                document.getElementById('fontFamily').value = "'Noto Serif SC', serif";
                document.getElementById('fontSize').value = 24;
                document.getElementById('lineHeight').value = 160;
                document.getElementById('letterSpacing').value = 0;
                document.getElementById('fontColor').value = '#333333';
                document.getElementById('fontColorText').value = '#333333';
                StyleManager.setAlignment('left');

                // 重置背景
                BackgroundManager.setType('color');
                document.getElementById('bgColor').value = '#f8fafc';
                document.getElementById('bgColorText').value = '#f8fafc';
                document.getElementById('bgOpacity').value = 100;
                BackgroundManager.currentImage = null;

                // 重置画布
                CanvasManager.updateSize(1080, 1080, '朋友圈单图');

                // 清除高亮
                Highlighter.clear();

                // 更新显示
                this.updateContent();
                StyleManager.updateControls();
                StyleManager.applyStyle();
                BackgroundManager.applyColor();

                // 清空历史
                History.clear();

                // 保存初始状态
                this.saveState();

                Toast.success('已重置所有内容');
            }
        };

        // ========== 初始化应用 ==========
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>