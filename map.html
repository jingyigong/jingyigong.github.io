<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>é«˜å¾·åœ°å›¾å®šä½ Demoï¼ˆåå‘åœ°ç†ç¼–ç  + æ‹–æ‹½ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!--
    æ³¨æ„ï¼šè¯·æŠŠ YOUR_AMAP_KEY æ›¿æ¢ä¸ºä½ çš„é«˜å¾· Web API Keyã€‚
    æˆ‘ä»¬åœ¨ URL ä¸­é€šè¿‡ plugin å‚æ•°ä¸€æ¬¡æ€§åŠ è½½ Geocoder ä¸ Geolocation æ’ä»¶ï¼Œé¿å…åç»­æ‰¾ä¸åˆ°æ’ä»¶å¯¼è‡´å®šä½ä¸ç”Ÿæ•ˆã€‚
  -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=b71feeaf4fdbd031d554ad3ef3d8c803&plugin=AMap.Geocoder,AMap.Geolocation"></script>

  <style>
    body { background: #f0f9f4; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "PingFang SC", "Microsoft Yahei", sans-serif; }
    #map { width:100%; height: 62vh; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(15,23,42,0.08); }
    .small-muted { color: #6b7280; font-size: 0.9rem; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

  <h1 class="text-2xl font-semibold text-emerald-700 mb-3">ğŸ“ é«˜å¾·åœ°å›¾ Demoï¼ˆè‹å·é»˜è®¤ï¼‰</h1>

  <div class="w-full max-w-xl space-y-3">
    <!-- åœ°å€è¾“å…¥ -->
    <div class="flex gap-2">
      <input id="addressInput" placeholder="è¾“å…¥åœ°å€å¹¶æŒ‰å›è½¦æˆ–ç‚¹å‡»ã€å®šä½ã€‘" class="flex-1 px-4 py-2 rounded-xl border border-emerald-200 focus:outline-none focus:ring-2 focus:ring-emerald-200" />
      <button id="btnLocate" class="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow">å®šä½</button>
      <button id="btnUseBrowser" class="px-3 py-2 rounded-xl bg-white border text-emerald-600">ä½¿ç”¨æµè§ˆå™¨å®šä½</button>
    </div>

    <!-- åæ ‡ä¸åœ°å€æ˜¾ç¤º -->
    <div class="bg-white rounded-xl p-3 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <div class="small-muted">å½“å‰åæ ‡ï¼ˆç», çº¬ï¼‰</div>
        <div class="small-muted">æ“ä½œæç¤ºï¼šç‚¹å‡»åœ°å›¾ï¼Œæˆ–æ‹–åŠ¨æ ‡è®°ä»¥ç²¾ç¡®å®šä½</div>
      </div>
      <div class="flex gap-4 items-center">
        <div class="flex-1">
          <div class="text-sm text-slate-700">ç»åº¦ (lng)</div>
          <div id="lng" class="text-lg font-mono text-emerald-700">--</div>
        </div>
        <div class="flex-1">
          <div class="text-sm text-slate-700">çº¬åº¦ (lat)</div>
          <div id="lat" class="text-lg font-mono text-emerald-700">--</div>
        </div>
      </div>
      <div class="mt-3">
        <div class="text-sm text-slate-700">åœ°å€ (åå‘è§£æ)</div>
        <div id="addressDisplay" class="text-sm text-slate-600 mt-1">--</div>
      </div>
    </div>

    <!-- åœ°å›¾ -->
    <div id="map" class="rounded-xl"></div>

    <!-- å°æŒ‰é’® -->
    <div class="flex gap-2">
      <button id="btnClearMarker" class="flex-1 px-4 py-2 rounded-xl bg-white border text-emerald-600">æ¸…é™¤æ ‡è®°</button>
      <button id="btnCenterSuzhou" class="flex-1 px-4 py-2 rounded-xl bg-white border text-emerald-600">å®šä½åˆ°è‹å·</button>
    </div>
  </div>

  <script>
    let map, marker = null, geocoder = null, geolocationPlugin = null;

    // åˆå§‹ä¸­å¿ƒï¼šè‹å·ï¼ˆlng, latï¼‰
    const DEFAULT_CENTER = [120.619585, 31.299379];

    function fmt(n) { return (typeof n === 'number') ? n.toFixed(6) : '--'; }

    function updateCoordsUI(lng, lat) {
      document.getElementById('lng').textContent = fmt(lng);
      document.getElementById('lat').textContent = fmt(lat);
    }

    function updateAddressUI(addr) {
      document.getElementById('addressDisplay').textContent = addr || '--';
    }

    function createOrMoveMarker(lng, lat) {
      if (!marker) {
        marker = new AMap.Marker({
          position: [lng, lat],
          draggable: true,
          title: 'é€‰ä¸­ä½ç½®ï¼ˆæ‹–åŠ¨å¯å¾®è°ƒï¼‰',
          map: map
        });

        // æ‹–æ‹½ç»“æŸæ›´æ–°åæ ‡å¹¶è¿›è¡Œåå‘åœ°ç†ç¼–ç 
        marker.on('dragend', (ev) => {
          const p = ev.lnglat;
          updateCoordsUI(p.getLng(), p.getLat());
          reverseGeocode(p.getLng(), p.getLat());
        });
      } else {
        marker.setPosition([lng, lat]);
      }
      // ä¸­å¿ƒåŒ–
      map.setCenter([lng, lat]);
    }

    // åå‘åœ°ç†ç¼–ç ï¼ˆåæ ‡ -> åœ°å€ï¼‰
    function reverseGeocode(lng, lat) {
      if (!geocoder) {
        console.warn('Geocoder æœªåˆå§‹åŒ–');
        return;
      }
      // geocoder.getAddress å¯æ¥å—å¯¹è±¡æˆ–åæ ‡æ•°ç»„
      geocoder.getAddress([lng, lat], function(status, result) {
        if (status === 'complete' && result.regeocode) {
          const addr = result.regeocode.formattedAddress || (result.regeocode.addressComponent || {});
          updateAddressUI(result.regeocode.formattedAddress || JSON.stringify(addr));
        } else {
          updateAddressUI('æœªèƒ½è§£æåœ°å€');
        }
      });
    }

    // åœ°å€æ­£å‘åœ°ç†ç¼–ç ï¼ˆåœ°å€ -> åæ ‡ï¼‰
    function geocodeAddress(text) {
      if (!geocoder) {
        alert('Geocoder æœªåˆå§‹åŒ–ï¼Œè¯·ç¨åé‡è¯•');
        return;
      }
      geocoder.getLocation(text, function(status, result) {
        if (status === 'complete' && result.geocodes && result.geocodes.length > 0) {
          const loc = result.geocodes[0].location;
          const lng = loc.lng, lat = loc.lat;
          createOrMoveMarker(lng, lat);
          updateCoordsUI(lng, lat);
          updateAddressUI(result.geocodes[0].formattedAddress || text);
          map.setZoom(15);
        } else {
          alert('æœªæ‰¾åˆ°è¯¥åœ°å€ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„æè¿°ï¼ˆå¦‚è¡—é“+é—¨ç‰Œå·ï¼‰');
        }
      });
    }

    // å°è¯•ä½¿ç”¨é«˜å¾·å®šä½æ’ä»¶ï¼›è‹¥å¤±è´¥ï¼Œå›é€€åˆ°æµè§ˆå™¨å®šä½
    function tryLocateByPluginOrBrowser() {
      if (geolocationPlugin) {
        geolocationPlugin.getCurrentPosition(function(status, result) {
          if (status === 'complete' && result && result.position) {
            const lng = result.position.lng, lat = result.position.lat;
            createOrMoveMarker(lng, lat);
            updateCoordsUI(lng, lat);
            reverseGeocode(lng, lat);
            return;
          }
          // å¦‚æœæ’ä»¶å®šä½å¤±è´¥ï¼Œå›é€€æµè§ˆå™¨å®šä½
          browserGeolocationFallback();
        }, (err) => {
          console.warn('é«˜å¾·æ’ä»¶å®šä½å¤±è´¥ï¼š', err);
          browserGeolocationFallback();
        });
      } else {
        browserGeolocationFallback();
      }
    }

    function browserGeolocationFallback() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          createOrMoveMarker(lng, lat);
          updateCoordsUI(lng, lat);
          reverseGeocode(lng, lat);
        }, (err) => {
          console.warn('æµè§ˆå™¨å®šä½å¤±è´¥ï¼š', err);
          alert('æ— æ³•è·å–ä½ç½®ï¼ˆè¯·å…è®¸å®šä½æˆ–æ£€æŸ¥æµè§ˆå™¨æƒé™ï¼‰ï¼Œå°†æ˜¾ç¤ºè‹å·é»˜è®¤ä½ç½®');
          // fallback center
          map.setCenter(DEFAULT_CENTER);
        }, { enableHighAccuracy: true, timeout: 8000 });
      } else {
        alert('æµè§ˆå™¨ä¸æ”¯æŒå®šä½ï¼Œå°†æ˜¾ç¤ºè‹å·é»˜è®¤ä½ç½®');
        map.setCenter(DEFAULT_CENTER);
      }
    }

        // åˆå§‹åŒ–åœ°å›¾ä¸æ’ä»¶
    function initMap() {
      map = new AMap.Map('map', {
        center: DEFAULT_CENTER,
        zoom: 13,
      });

      // åˆå§‹åŒ– Geocoderï¼ˆæ’ä»¶å·²é€šè¿‡ URL åŠ è½½ï¼‰
      try {
        geocoder = new AMap.Geocoder({ 
          city: '010',  // è®¾ç½®åŸå¸‚ï¼Œ010ä»£è¡¨å…¨å›½èŒƒå›´
          radius: 1000
        });
        console.log('Geocoder åˆå§‹åŒ–æˆåŠŸ');
      } catch (e) {
        console.error('Geocoder åˆå§‹åŒ–å¤±è´¥:', e);
      }

      // åˆå§‹åŒ– Geolocation æ’ä»¶
      try {
        geolocationPlugin = new AMap.Geolocation({
          enableHighAccuracy: true,
          timeout: 10000,
          buttonPosition: 'RB',
          zoomToAccuracy: true
        });
        map.addControl(geolocationPlugin);
        console.log('Geolocation åˆå§‹åŒ–æˆåŠŸ');
      } catch (e) {
        console.error('Geolocation åˆå§‹åŒ–å¤±è´¥:', e);
      }

      // å¦‚æœç”¨æˆ·ç‚¹å‡»åœ°å›¾ï¼Œåˆ›å»º/ç§»åŠ¨æ ‡è®°å¹¶åå‘è§£æåœ°å€
      map.on('click', function(e) {
        const lng = e.lnglat.getLng(), lat = e.lnglat.getLat();
        createOrMoveMarker(lng, lat);
        updateCoordsUI(lng, lat);
        reverseGeocode(lng, lat);
      });

      // ç­‰å¾…åœ°å›¾å®Œå…¨åŠ è½½åå†å°è¯•å®šä½
      map.on('complete', function() {
        console.log('åœ°å›¾åŠ è½½å®Œæˆ');
        // å»¶è¿Ÿæ‰§è¡Œå®šä½ï¼Œç¡®ä¿æ‰€æœ‰æ’ä»¶å°±ç»ª
        setTimeout(() => {
          tryLocateByPluginOrBrowser();
        }, 500);
      });
    }

    // äº‹ä»¶ç»‘å®š
    window.addEventListener('load', () => {
      initMap();

      // åœ°å€è¾“å…¥å›è½¦å’ŒæŒ‰é’®
      const addrInput = document.getElementById('addressInput');
      const btnLocate = document.getElementById('btnLocate');
      addrInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const txt = addrInput.value.trim();
          if (txt) geocodeAddress(txt);
        }
      });
      btnLocate.addEventListener('click', () => {
        const txt = addrInput.value.trim();
        if (!txt) { alert('è¯·è¾“å…¥åœ°å€å…³é”®è¯'); return; }
        geocodeAddress(txt);
      });

      // ä½¿ç”¨æµè§ˆå™¨å®šä½æŒ‰é’®ï¼ˆæ‰‹åŠ¨è§¦å‘å›é€€å®šä½ï¼‰
      document.getElementById('btnUseBrowser').addEventListener('click', () => {
        browserGeolocationFallback();
      });

      // æ¸…é™¤æ ‡è®°
      document.getElementById('btnClearMarker').addEventListener('click', () => {
        if (marker) { marker.setMap(null); marker = null; }
        updateCoordsUI(null, null); updateAddressUI(null);
      });

      // å›åˆ°è‹å·ä¸­å¿ƒ
      document.getElementById('btnCenterSuzhou').addEventListener('click', () => {
        map.setCenter(DEFAULT_CENTER); map.setZoom(12);
      });
    });
  </script>
</body>
</html>
